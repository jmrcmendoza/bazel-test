package(default_visibility = ["//visibility:public"])

load("@npm//@bazel/typescript:index.bzl", "ts_project")

PRODUCTION_DEPENDENCIES = [
    "@npm//@highoutput/logger",
    "@npm//@koa/multer",
    "@npm//aglio",
    "@npm//async-exit-hook",
    "@npm//deep-equal",
    "@npm//highoutput-auth",
    "@npm//koa",
    "@npm//koa-bodyparser",
    "@npm//koa-router",
    "@npm//koa-send",
    "@npm//mime-types",
    "@npm//ms",
    "@npm//multer",
    "@npm//ramda",
    "@npm//rethinkdb",
    "@npm//socket.io",
    "@npm//tiny-typed-emitter",
    "@npm//try-to-catch",
    "@npm//uuid",
    "@npm//ws",
]

ts_project(
    name = "compile",
    srcs = glob(
        ["**/*.ts"],
        exclude = [
            "tests/**/*.*",
            "node_modules/**/*.*",
        ],
    ),
    source_map = True,
    validate = False,
    tsconfig = "tsconfig.json",
    extends = "//:tsconfig.json",
    deps = PRODUCTION_DEPENDENCIES + [
        "@npm//@types/ajv",
        "@npm//@types/aws-sdk",
        "@npm//@types/big.js",
        "@npm//@types/bluebird",
        "@npm//@types/chai",
        "@npm//@types/chai-as-promised",
        "@npm//@types/chance",
        "@npm//@types/deep-equal",
        "@npm//@types/graphql",
        "@npm//@types/graphql-iso-date",
        "@npm//@types/graphql-type-json",
        "@npm//@types/koa",
        "@npm//@types/koa-bodyparser",
        "@npm//@types/koa-router",
        "@npm//@types/koa-static",
        "@npm//@types/koa__multer",
        "@npm//@types/lru-cache",
        "@npm//@types/mocha",
        "@npm//@types/ms",
        "@npm//@types/node",
        "@npm//@types/node-fetch",
        "@npm//@types/qrcode",
        "@npm//@types/ramda",
        "@npm//@types/rethinkdb",
        "@npm//@types/serialize-error",
        "@npm//@types/sinon",
        "@npm//@types/supertest",
        "@npm//@types/uuid",
        "@npm//@types/ws",
        "@npm//@typescript-eslint/eslint-plugin",
        "@npm//@typescript-eslint/parser",
        "@npm//chai",
        "@npm//chai-as-promised",
        "@npm//chance",
        "@npm//cross-env",
        "@npm//eslint",
        "@npm//eslint-config-airbnb-base",
        "@npm//eslint-config-airbnb-typescript",
        "@npm//eslint-config-prettier",
        "@npm//eslint-import-resolver-typescript",
        "@npm//eslint-plugin-import",
        "@npm//eslint-plugin-prettier",
        "@npm//husky",
        "@npm//mocha",
        "@npm//nyc",
        "@npm//p-wait-for",
        "@npm//prettier",
        "@npm//sinon",
        "@npm//socket.io-client",
        "@npm//subscriptions-transport-ws",
        "@npm//supertest",
        "@npm//ts-node",
        "@npm//tsconfig-paths",
        "@npm//tscpaths",
        "@npm//typescript",
    ],
)

load("@npm//mocha:index.bzl", "mocha_test")

mocha_test(
    name = "tests",
    args = [
        "--config=projects/hovchat/.mocharc.json",
        "--files=true",
        "--project=projects/hovchat/tsconfig.json",
    ],
    data = glob([
        "src/**/*.ts",
        "test/**/*.*",
        "tsconfig.json",
        ".mocharc.json",
    ]) + PRODUCTION_DEPENDENCIES + [
        "//:tsconfig.json",
        "@npm//@types/ajv",
        "@npm//@types/aws-sdk",
        "@npm//@types/big.js",
        "@npm//@types/bluebird",
        "@npm//@types/chai",
        "@npm//@types/chai-as-promised",
        "@npm//@types/chance",
        "@npm//@types/deep-equal",
        "@npm//@types/graphql",
        "@npm//@types/graphql-iso-date",
        "@npm//@types/graphql-type-json",
        "@npm//@types/koa",
        "@npm//@types/koa-bodyparser",
        "@npm//@types/koa-router",
        "@npm//@types/koa-static",
        "@npm//@types/koa__multer",
        "@npm//@types/lru-cache",
        "@npm//@types/mocha",
        "@npm//@types/ms",
        "@npm//@types/node",
        "@npm//@types/node-fetch",
        "@npm//@types/qrcode",
        "@npm//@types/ramda",
        "@npm//@types/rethinkdb",
        "@npm//@types/serialize-error",
        "@npm//@types/sinon",
        "@npm//@types/supertest",
        "@npm//@types/uuid",
        "@npm//@types/ws",
        "@npm//@typescript-eslint/eslint-plugin",
        "@npm//@typescript-eslint/parser",
        "@npm//chai",
        "@npm//chai-as-promised",
        "@npm//chance",
        "@npm//cross-env",
        "@npm//eslint",
        "@npm//eslint-config-airbnb-base",
        "@npm//eslint-config-airbnb-typescript",
        "@npm//eslint-config-prettier",
        "@npm//eslint-import-resolver-typescript",
        "@npm//eslint-plugin-import",
        "@npm//eslint-plugin-prettier",
        "@npm//husky",
        "@npm//nyc",
        "@npm//p-wait-for",
        "@npm//prettier",
        "@npm//sinon",
        "@npm//socket.io-client",
        "@npm//subscriptions-transport-ws",
        "@npm//supertest",
        "@npm//ts-node",
        "@npm//tsconfig-paths",
        "@npm//tscpaths",
        "@npm//typescript",
    ],
)

filegroup(
    name = "extra",
    srcs = glob([
        "schema/**/*",
    ]),
)